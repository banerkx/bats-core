#!/bin/bash

files+=" test/cat-formatter.bats"
files+=" test/concurrent-coordination.bash"
files+=" test/filter.bats"
files+=" test/fixtures/bats/BATS_TMPDIR.bats"
files+=" test/fixtures/bats/dos_line_no_shellcheck.bats"
files+=" test/fixtures/bats/duplicate-tests_no_shellcheck.bats"
files+=" test/fixtures/bats/dynamic_test_registration.bats"
files+=" test/fixtures/bats/empty.bats"
files+=" test/fixtures/bats/environment.bats"
files+=" test/fixtures/bats/evaluation_count/file1.bats"
files+=" test/fixtures/bats/evaluation_count/file2.bats"
files+=" test/fixtures/bats/expand_var_in_test_name.bats"
files+=" test/fixtures/bats/exported_function.bats"
files+=" test/fixtures/bats/external_function_calls.bats"
files+=" test/fixtures/bats/external_functions.bash"
files+=" test/fixtures/bats/external_functions.bats"
files+=" test/fixtures/bats/failing.bats"
files+=" test/fixtures/bats/failing_and_passing.bats"
files+=" test/fixtures/bats/failing_helper.bats"
files+=" test/fixtures/bats/failing_setup.bats"
files+=" test/fixtures/bats/failing_teardown.bats"
files+=" test/fixtures/bats/failing_with_bash_cond.bats"
files+=" test/fixtures/bats/failing_with_bash_expression.bats"
files+=" test/fixtures/bats/failing_with_negated_command.bats"
files+=" test/fixtures/bats/failure_callback_setup_suite/dummy.bats"
files+=" test/fixtures/bats/failure_in_free_code.bats"
files+=" test/fixtures/bats/focus.bats"
files+=" test/fixtures/bats/hang_after_run.bats"
files+=" test/fixtures/bats/hang_in_run.bats"
files+=" test/fixtures/bats/hang_in_setup_file.bats"
files+=" test/fixtures/bats/hang_in_teardown.bats"
files+=" test/fixtures/bats/hang_in_teardown_file.bats"
files+=" test/fixtures/bats/hang_in_test.bats"
files+=" test/fixtures/bats/issue-433/repro1.bats"
files+=" test/fixtures/bats/issue-433/repro2.bats"
files+=" test/fixtures/bats/issue-519.bats"
files+=" test/fixtures/bats/load.bats"
files+=" test/fixtures/bats/loop_keep_IFS.bats"
files+=" test/fixtures/bats/many_passing_and_one_failing.bats"
files+=" test/fixtures/bats/no-final-newline.bats"
files+=" test/fixtures/bats/output.bats"
files+=" test/fixtures/bats/override_date_on_path.bats"
files+=" test/fixtures/bats/parallel.bats"
files+=" test/fixtures/bats/passing.bats"
files+=" test/fixtures/bats/passing_and_failing.bats"
files+=" test/fixtures/bats/passing_and_skipping.bats"
files+=" test/fixtures/bats/passing_failing_and_skipping.bats"
files+=" test/fixtures/bats/preserve_IFS/helper.bash"
files+=" test/fixtures/bats/print_output_on_failure.bats"
files+=" test/fixtures/bats/print_output_on_failure_with_stderr.bats"
files+=" test/fixtures/bats/quoted_and_unquoted_test_names_no_shellcheck.bats"
files+=" test/fixtures/bats/reference_unset_parameter.bats"
files+=" test/fixtures/bats/reference_unset_parameter_in_setup.bats"
files+=" test/fixtures/bats/reference_unset_parameter_in_teardown.bats"
files+=" test/fixtures/bats/retry.bats"
files+=" test/fixtures/bats/run_long_command.bats"
files+=" test/fixtures/bats/set_-eu_in_setup_and_teardown.bats"
files+=" test/fixtures/bats/setup.bats"
files+=" test/fixtures/bats/show-output-of-passing-tests.bats"
files+=" test/fixtures/bats/sigint_in_failing_test.bats"
files+=" test/fixtures/bats/single_line_no_shellcheck.bats"
files+=" test/fixtures/bats/skipped.bats"
files+=" test/fixtures/bats/skipped_with_parens.bats"
files+=" test/fixtures/bats/source_nonexistent_file.bats"
files+=" test/fixtures/bats/source_nonexistent_file_in_setup.bats"
files+=" test/fixtures/bats/source_nonexistent_file_in_teardown.bats"
files+=" test/fixtures/bats/tab in filename.bats"
files+=" test/fixtures/bats/teardown.bats"
files+=" test/fixtures/bats/teardown_file_override_status.bats"
files+=" test/fixtures/bats/teardown_override_status.bats"
files+=" test/fixtures/bats/teardown_suite_override_status/setup_suite.bash"
files+=" test/fixtures/bats/teardown_suite_override_status/test.bats"
files+=" test/fixtures/bats/test_helper.bash"
files+=" test/fixtures/bats/test_with_slash.bats"
files+=" test/fixtures/bats/unbound_variable.bats"
files+=" test/fixtures/bats/update_path_env.bats"
files+=" test/fixtures/bats/verbose-run.bats"
files+=" test/fixtures/bats/whitespace_no_shellcheck.bats"
files+=" test/fixtures/bats/without_trailing_newline.bats"
files+=" test/fixtures/file_setup_teardown/error_in_setup_and_teardown_file.bats"
files+=" test/fixtures/file_setup_teardown/no_setup_file.bats"
files+=" test/fixtures/file_setup_teardown/no_teardown_file.bats"
files+=" test/fixtures/file_setup_teardown/setup_file.bats"
files+=" test/fixtures/file_setup_teardown/setup_file2.bats"
files+=" test/fixtures/file_setup_teardown/setup_file_does_not_leak_env.bats"
files+=" test/fixtures/file_setup_teardown/setup_file_does_not_leak_env2.bats"
files+=" test/fixtures/file_setup_teardown/setup_file_even_if_all_tests_are_skipped.bats"
files+=" test/fixtures/file_setup_teardown/setup_file_failed.bats"
files+=" test/fixtures/file_setup_teardown/setup_file_halfway_error.bats"
files+=" test/fixtures/file_setup_teardown/teardown_file.bats"
files+=" test/fixtures/file_setup_teardown/teardown_file2.bats"
files+=" test/fixtures/file_setup_teardown/teardown_file_after_failing_test.bats"
files+=" test/fixtures/file_setup_teardown/teardown_file_after_long_test.bats"
files+=" test/fixtures/file_setup_teardown/teardown_file_does_not_leak.bats"
files+=" test/fixtures/file_setup_teardown/teardown_file_does_not_leak2.bats"
files+=" test/fixtures/file_setup_teardown/teardown_file_even_if_all_tests_are_skipped.bats"
files+=" test/fixtures/file_setup_teardown/teardown_file_failed.bats"
files+=" test/fixtures/file_setup_teardown/teardown_file_halfway_error.bats"
files+=" test/fixtures/formatter/failing.bats"
files+=" test/fixtures/formatter/passing.bats"
files+=" test/fixtures/formatter/passing_and_skipping.bats"
files+=" test/fixtures/formatter/passing_failing_and_skipping.bats"
files+=" test/fixtures/formatter/skipped_with_parens.bats"
files+=" test/fixtures/junit-formatter/duplicate/first/file1.bats"
files+=" test/fixtures/junit-formatter/duplicate/second/file1.bats"
files+=" test/fixtures/junit-formatter/suite/file1.bats"
files+=" test/fixtures/junit-formatter/suite/file2.bats"
files+=" test/fixtures/junit-formatter/xml-escape.bats"
files+=" test/fixtures/load/ambiguous.bash"
files+=" test/fixtures/load/bats_load_library.bats"
files+=" test/fixtures/load/exit1.bash"
files+=" test/fixtures/load/failing_load.bats"
files+=" test/fixtures/load/find_library_helper.bats"
files+=" test/fixtures/load/find_library_helper_err.bats"
files+=" test/fixtures/load/load.bats"
files+=" test/fixtures/load/load_in_teardown_after_failure.bats"
files+=" test/fixtures/load/return1.bash"
files+=" test/fixtures/load/test_helper.bash"
files+=" test/fixtures/parallel/must_not_parallelize_across_files/file1.bats"
files+=" test/fixtures/parallel/must_not_parallelize_across_files/file2.bats"
files+=" test/fixtures/parallel/must_not_parallelize_within_file.bats"
files+=" test/fixtures/parallel/parallel-preserve-environment.bats"
files+=" test/fixtures/parallel/parallel.bats"
files+=" test/fixtures/parallel/parallel_factor.bats"
files+=" test/fixtures/parallel/setup_file/setup_file.bats"
files+=" test/fixtures/parallel/setup_file/setup_file1.bats"
files+=" test/fixtures/parallel/setup_file/setup_file2.bats"
files+=" test/fixtures/parallel/setup_file/setup_file3.bats"
files+=" test/fixtures/parallel/suite/parallel1.bats"
files+=" test/fixtures/parallel/suite/parallel2.bats"
files+=" test/fixtures/parallel/suite/parallel3.bats"
files+=" test/fixtures/parallel/suite/parallel4.bats"
files+=" test/fixtures/run/invalid.bats"
files+=" test/fixtures/suite/errors_in_multiple_load/a.bats"
files+=" test/fixtures/suite/errors_in_multiple_load/b.bats"
files+=" test/fixtures/suite/errors_in_multiple_load/c.bats"
files+=" test/fixtures/suite/errors_in_multiple_load/test_helper.bash"
files+=" test/fixtures/suite/filter/a.bats"
files+=" test/fixtures/suite/filter/b.bats"
files+=" test/fixtures/suite/filter/c.bats"
files+=" test/fixtures/suite/multiple/a.bats"
files+=" test/fixtures/suite/multiple/b.bats"
files+=" test/fixtures/suite/multiple_load_constants/a.bats"
files+=" test/fixtures/suite/multiple_load_constants/b.bats"
files+=" test/fixtures/suite/recursive/subsuite/test2.bats"
files+=" test/fixtures/suite/recursive/test.bats"
files+=" test/fixtures/suite/recursive_with_symlinks/test.bats"
files+=" test/fixtures/suite/single/test.bats"
files+=" test/fixtures/suite_setup_teardown/call_load/setup_suite.bash"
files+=" test/fixtures/suite_setup_teardown/call_load/test.bats"
files+=" test/fixtures/suite_setup_teardown/call_load/test_helper.bash"
files+=" test/fixtures/suite_setup_teardown/default_name/setup_suite.bash"
files+=" test/fixtures/suite_setup_teardown/default_name/test.bats"
files+=" test/fixtures/suite_setup_teardown/error_in_free_code/setup_suite.bash"
files+=" test/fixtures/suite_setup_teardown/error_in_free_code/test.bats"
files+=" test/fixtures/suite_setup_teardown/error_in_setup_suite/setup_suite.bash"
files+=" test/fixtures/suite_setup_teardown/error_in_setup_suite/test.bats"
files+=" test/fixtures/suite_setup_teardown/error_in_teardown_suite/setup_suite.bash"
files+=" test/fixtures/suite_setup_teardown/error_in_teardown_suite/test.bats"
files+=" test/fixtures/suite_setup_teardown/exported_vars/setup_suite.bash"
files+=" test/fixtures/suite_setup_teardown/exported_vars/test.bats"
files+=" test/fixtures/suite_setup_teardown/failure_in_setup_suite/setup_suite.bash"
files+=" test/fixtures/suite_setup_teardown/failure_in_setup_suite/test.bats"
files+=" test/fixtures/suite_setup_teardown/failure_in_teardown_suite/setup_suite.bash"
files+=" test/fixtures/suite_setup_teardown/failure_in_teardown_suite/test.bats"
files+=" test/fixtures/suite_setup_teardown/no_failure_no_output/setup_suite.bash"
files+=" test/fixtures/suite_setup_teardown/no_failure_no_output/test.bats"
files+=" test/fixtures/suite_setup_teardown/no_setup_suite_function/setup_suite.bash"
files+=" test/fixtures/suite_setup_teardown/no_setup_suite_function/test.bats"
files+=" test/fixtures/suite_setup_teardown/non_default_name/setup_suite_non_default.bash"
files+=" test/fixtures/suite_setup_teardown/non_default_name/test.bats"
files+=" test/fixtures/suite_setup_teardown/output_with_failure/setup_suite.bash"
files+=" test/fixtures/suite_setup_teardown/output_with_failure/test.bats"
files+=" test/fixtures/suite_setup_teardown/pick_up_toplevel/folder1/setup_suite.bash"
files+=" test/fixtures/suite_setup_teardown/pick_up_toplevel/folder1/test.bats"
files+=" test/fixtures/suite_setup_teardown/pick_up_toplevel/folder2/setup_suite.bash"
files+=" test/fixtures/suite_setup_teardown/pick_up_toplevel/folder2/test.bats"
files+=" test/fixtures/suite_setup_teardown/pick_up_toplevel/setup_suite.bash"
files+=" test/fixtures/suite_setup_teardown/pick_up_toplevel/test.bats"
files+=" test/fixtures/suite_setup_teardown/return_nonzero_in_teardown_suite/setup_suite.bash"
files+=" test/fixtures/suite_setup_teardown/return_nonzero_in_teardown_suite/test.bats"
files+=" test/fixtures/suite_setup_teardown/skip_in_setup_file.bats"
files+=" test/fixtures/suite_setup_teardown/stderr_in_setup_teardown_suite/setup_suite.bash"
files+=" test/fixtures/suite_setup_teardown/stderr_in_setup_teardown_suite/test.bats"
files+=" test/fixtures/suite_setup_teardown/syntax_error/test.bats"
files+=" test/fixtures/tagging/BATS_TEST_TAGS.bats"
files+=" test/fixtures/tagging/tagged.bats"
files+=" test/fixtures/timeout/sleep2.bats"
files+=" test/fixtures/trace/failing_complex.bats"
files+=" test/fixtures/trace/failing_recursive.bats"
files+=" test/fixtures/warnings/BW01.bats"
files+=" test/fixtures/warnings/BW01_check_exit_code_is_127.bats"
files+=" test/fixtures/warnings/BW01_no_exit_code_check_no_exit_code_127.bats"
files+=" test/fixtures/warnings/BW02.bats"
files+=" test/fixtures/warnings/BW03/define_setup_suite_in_wrong_file.bats"
files+=" test/fixtures/warnings/BW03/non_default_setup_suite.bash"
files+=" test/fixtures/warnings/BW03/suppress_warning.bats"
files+=" test/run.bats"
files+=" test/suite.bats"
files+=" test/suite_setup_teardown.bats"
files+=" test/tap13-formatter.bats"
files+=" test/timeout.bats"

cd ..
declare -r shell='# shellcheck shell=XXXX'
declare -i lines=0
for file in ${files}
do
  if [[ ! -s "${file}" ]]
  then
    continue
  fi
  lines=$(wc -l "${file}" | cut -d' ' -f1)
  if [[ ${lines} -le 1 ]]
  then
    continue
  fi
  grep -q '^# \+shellcheck \+shell=' "${file}"
  if [[ 0 -eq ${?} ]]
  then
    continue
  fi
  base="$(basename "${file}")"
  ext="${base##*.}"
  case "${ext}" in
    bash | bats ) :;;
    *           ) continue;;
  esac
  sed -i "1i${shell/XXXX/${ext}}" "${file}"
done
